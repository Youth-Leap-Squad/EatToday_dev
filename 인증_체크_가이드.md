# ğŸ” JWT í† í° ì¸ì¦ ì²´í¬ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“Œ ê°œìš”
í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” JWT í† í° ê¸°ë°˜ ì¸ì¦ì´ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.  
ê²Œì‹œë¬¼ ì‘ì„±, ëŒ“ê¸€ ì‘ì„±, ë¦¬ë·° ì‘ì„± ë“± **ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥**ì„ êµ¬í˜„í•  ë•ŒëŠ” ë°˜ë“œì‹œ í† í° ì¸ì¦ ì²´í¬ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.

---

## âš ï¸ ì ˆëŒ€ í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒ

### âŒ BAD: memberNoë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ ë°›ê¸°
```java
@PostMapping("/foods")
public ResponseEntity<?> createPost(@RequestBody CreatePostRequest req) {
    // req.getMemberNo()ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© - ìœ„í—˜!
    postService.createPost(req.getMemberNo(), req.getContent());
    return ResponseEntity.ok().build();
}
```
**ë¬¸ì œì **: í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ë¥¸ ì‚¬ëŒì˜ memberNoë¥¼ ë³´ë‚´ë©´ ê·¸ ì‚¬ëŒ ëŒ€ì‹  ê¸€ì„ ì“¸ ìˆ˜ ìˆìŒ!

---

## âœ… ì˜¬ë°”ë¥¸ ë°©ë²• 3ê°€ì§€

### ë°©ë²• 1ï¸âƒ£: @AuthenticationPrincipal ì‚¬ìš© (ê°€ì¥ ì¶”ì²œ!)

```java
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import com.eat.today.configure.security.CustomUserDetails;

@PostMapping("/foods")
public ResponseEntity<?> createPost(
        @AuthenticationPrincipal CustomUserDetails userDetails,  // ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ì‚¬ìš©ì ì£¼ì…
        @RequestBody CreatePostRequest req) {
    
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    Integer memberNo = userDetails.getMemberNo();
    String email = userDetails.getUsername();
    
    postService.createPost(memberNo, req.getContent());
    return ResponseEntity.ok().build();
}
```

**ì¥ì **: 
- ê°€ì¥ ê°„ë‹¨í•˜ê³  ëª…í™•
- Springì´ ìë™ìœ¼ë¡œ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì£¼ì…
- í† í°ì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ 401 ì—ëŸ¬

---

### ë°©ë²• 2ï¸âƒ£: SecurityContextHolder ì§ì ‘ ì‚¬ìš©

```java
import org.springframework.security.core.context.SecurityContextHolder;
import com.eat.today.configure.security.CustomUserDetails;

@PostMapping("/comments")
public ResponseEntity<?> createComment(@RequestBody CommentRequest req) {
    
    // í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    CustomUserDetails userDetails = (CustomUserDetails) SecurityContextHolder
            .getContext()
            .getAuthentication()
            .getPrincipal();
    
    Integer memberNo = userDetails.getMemberNo();
    
    commentService.createComment(memberNo, req.getContent());
    return ResponseEntity.ok().build();
}
```

**ì‚¬ìš© ì‹œê¸°**: 
- Service ë ˆì´ì–´ì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•  ë•Œ
- ë©”ì„œë“œ ì¤‘ê°„ì— ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•  ë•Œ

---

### ë°©ë²• 3ï¸âƒ£: @PreAuthorizeë¡œ ê¶Œí•œ ì²´í¬ (ADMIN ì „ìš© ê¸°ëŠ¥)

```java
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import com.eat.today.configure.security.CustomUserDetails;

// ADMINë§Œ ê°€ëŠ¥
@PreAuthorize("hasRole('ADMIN')")
@PostMapping("/alcohols")
public ResponseEntity<?> createAlcohol(
        @AuthenticationPrincipal CustomUserDetails userDetails,
        @RequestBody AlcoholRequest req) {
    
    alcoholService.createAlcohol(req);
    return ResponseEntity.ok().build();
}

// USER ì´ìƒì´ë©´ ê°€ëŠ¥
@PreAuthorize("hasAnyRole('USER', 'ADMIN')")
@PostMapping("/foods")
public ResponseEntity<?> createFood(...) {
    // ...
}

// ë³¸ì¸ ë˜ëŠ” ADMINë§Œ ìˆ˜ì • ê°€ëŠ¥
@PreAuthorize("hasRole('ADMIN') or #memberNo == authentication.principal.memberNo")
@PatchMapping("/members/{memberNo}")
public ResponseEntity<?> updateMember(
        @PathVariable Integer memberNo,
        @RequestBody UpdateRequest req) {
    // ...
}
```

---

## ğŸ“ ì‹¤ì œ ì ìš© ì˜ˆì‹œ

### Before (ìœ„í—˜) âŒ
```java
@PostMapping("/foods")
public ResponseEntity<FoodPostResponse> createPost(@RequestBody CreatePostRequest req) {
    // í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ memberNoë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    FoodPostResponse body = svc.createPost(req.getMemberNo(), req);
    return ResponseEntity.ok(body);
}

@DeleteMapping("/comments/{commentId}")
public void deleteComment(
        @PathVariable Integer commentId,
        @RequestParam Integer memberNo) {  // âŒ ìœ„í—˜!
    commentService.delete(commentId, memberNo);
}
```

### After (ì•ˆì „) âœ…
```java
@PostMapping("/foods")
public ResponseEntity<FoodPostResponse> createPost(
        @AuthenticationPrincipal CustomUserDetails userDetails,  // âœ… ì•ˆì „
        @RequestBody CreatePostRequest req) {
    
    // í† í°ì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë¡œê·¸ì¸ ì‚¬ìš©ì
    Integer memberNo = userDetails.getMemberNo();
    
    FoodPostResponse body = svc.createPost(memberNo, req);
    return ResponseEntity.ok(body);
}

@DeleteMapping("/comments/{commentId}")
public void deleteComment(
        @PathVariable Integer commentId,
        @AuthenticationPrincipal CustomUserDetails userDetails) {  // âœ… ì•ˆì „
    
    Integer memberNo = userDetails.getMemberNo();
    commentService.delete(commentId, memberNo);
}
```

---

## ğŸ”§ Service ë ˆì´ì–´ì—ì„œ ì‚¬ìš©í•˜ê¸°

Controllerê°€ ì•„ë‹Œ Serviceì—ì„œë„ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@Service
@Transactional
public class PostCommandServiceImpl implements PostCommandService {
    
    public void createPost(CreatePostRequest req) {
        // Serviceì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
        CustomUserDetails userDetails = (CustomUserDetails) SecurityContextHolder
                .getContext()
                .getAuthentication()
                .getPrincipal();
        
        Integer currentMemberNo = userDetails.getMemberNo();
        
        // ê²Œì‹œë¬¼ ìƒì„± ë¡œì§
        FoodPost post = new FoodPost();
        post.setMemberNo(currentMemberNo);  // í† í°ì—ì„œ ê°€ì ¸ì˜¨ ì§„ì§œ ì‚¬ìš©ì
        post.setContent(req.getContent());
        
        postRepository.save(post);
    }
}
```

---

## ğŸ›¡ï¸ ë³¸ì¸ í™•ì¸ì´ í•„ìš”í•œ ê²½ìš°

ìˆ˜ì •/ì‚­ì œ ê°™ì€ ê²½ìš° **ë³¸ì¸ì´ ì‘ì„±í•œ ê¸€ì¸ì§€ í™•ì¸**ì´ í•„ìš”í•©ë‹ˆë‹¤.

```java
@DeleteMapping("/foods/{boardNo}")
public ResponseEntity<?> deletePost(
        @PathVariable Integer boardNo,
        @AuthenticationPrincipal CustomUserDetails userDetails) {
    
    Integer currentMemberNo = userDetails.getMemberNo();
    
    // Serviceì—ì„œ ë³¸ì¸ í™•ì¸
    postService.deletePost(boardNo, currentMemberNo);
    
    return ResponseEntity.noContent().build();
}
```

```java
// Service
public void deletePost(Integer boardNo, Integer memberNo) {
    FoodPost post = postRepository.findById(boardNo)
            .orElseThrow(() -> new EntityNotFoundException("ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    
    // ë³¸ì¸ì´ ì“´ ê¸€ì¸ì§€ í™•ì¸
    if (!post.getMemberNo().equals(memberNo)) {
        throw new IllegalStateException("ë³¸ì¸ì´ ì‘ì„±í•œ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
    
    postRepository.delete(post);
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. Postman/Thunder Clientë¡œ í…ŒìŠ¤íŠ¸

```
POST http://localhost:8080/command/foods
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Content-Type: application/json
Body:
{
  "content": "ë§›ìˆëŠ” ì•ˆì£¼ ì¶”ì²œí•©ë‹ˆë‹¤"
}
```

### 2. í† í° ì—†ì´ ìš”ì²­í•˜ë©´?
â†’ 401 Unauthorized ì—ëŸ¬ ë°œìƒ (ì •ìƒ)

### 3. ë§Œë£Œëœ í† í°ìœ¼ë¡œ ìš”ì²­í•˜ë©´?
â†’ 401 Unauthorized ì—ëŸ¬ ë°œìƒ (ì •ìƒ)

---

## â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸

### Q1: ë¡œê·¸ì¸ì´ í•„ìš” ì—†ëŠ” APIëŠ”?
A: ì¡°íšŒ(GET) APIëŠ” ëŒ€ë¶€ë¶„ ë¡œê·¸ì¸ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
```java
// ë¡œê·¸ì¸ ë¶ˆí•„ìš” - ëˆ„êµ¬ë‚˜ ê²Œì‹œë¬¼ ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥
@GetMapping("/foods")
public ResponseEntity<?> getFoodList() {
    return ResponseEntity.ok(postService.getList());
}
```

### Q2: userDetailsê°€ nullì´ë©´?
A: í† í°ì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ Spring Securityê°€ ìë™ìœ¼ë¡œ 401 ì—ëŸ¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.  
ëª…ì‹œì ìœ¼ë¡œ ì²´í¬í•˜ë ¤ë©´:
```java
if (userDetails == null) {
    return ResponseEntity.status(401).body("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
}
```

### Q3: ADMINì¸ì§€ í™•ì¸í•˜ë ¤ë©´?
```java
if (userDetails.getMemberRole() == MemberEntity.Role.ADMIN) {
    // ADMIN ì „ìš© ë¡œì§
}
```

ë˜ëŠ”
```java
@PreAuthorize("hasRole('ADMIN')")
```

---

## ğŸ“ ë¬¸ì˜ì‚¬í•­
ì¸ì¦/ë³´ì•ˆ ê´€ë ¨ ë¬¸ì˜: Spring Security ë‹´ë‹¹ìì—ê²Œ ì—°ë½

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

êµ¬í˜„ ì‹œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] `@RequestParam` ë˜ëŠ” `@RequestBody`ë¡œ memberNoë¥¼ ë°›ì§€ ì•Šì•˜ëŠ”ê°€?
- [ ] `@AuthenticationPrincipal CustomUserDetails`ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?
- [ ] ìˆ˜ì •/ì‚­ì œ ì‹œ ë³¸ì¸ í™•ì¸ ë¡œì§ì´ ìˆëŠ”ê°€?
- [ ] ADMIN ì „ìš© ê¸°ëŠ¥ì— `@PreAuthorize("hasRole('ADMIN')")`ë¥¼ ë¶™ì˜€ëŠ”ê°€?
- [ ] í† í° ì—†ì´ ìš”ì²­í–ˆì„ ë•Œ 401 ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ê°€?


