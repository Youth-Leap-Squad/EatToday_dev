<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eat.today.sns.query.repository.photoReview.PRMapper">

    <!-- 첨부파일 매핑 -->
    <resultMap id="FileMap" type="com.eat.today.qna_rounge_report.rounge.query.dto.PrFileUploadDTO">
        <id     property="prFileNo"     column="pr_file_no"/>
        <result property="reviewNo"      column="review_no"/>
        <result property="prFileName"    column="pr_file_name"/>
        <result property="prFileType"    column="pr_file_type"/>
        <result property="prFileRename"  column="pr_file_rename"/>
        <result property="prFilePath"    column="pr_file_path"/>
        <result property="prFileAt"      column="pr_file_at"/>
        <result column="pr_file_url"  property="prFileUrl"/>
    </resultMap>

    <!-- 리뷰 + 파일 조인용 resultMap -->
    <resultMap id="PhotoReviewMap" type="com.eat.today.sns.query.dto.photoReview.PRDTO">
        <id     property="reviewNo"    column="review_no"/>
        <result property="boardNo"     column="board_no"/>
        <result property="memberNo"    column="member_no"/>
        <result property="reviewTitle" column="review_title"/>
        <result property="reviewContent" column="review_content"/>
        <result property="reviewDate"  column="review_date"/>
        <result property="reviewLike"  column="review_like"/>

        <!-- 첨부파일 목록 매핑 (1:N) -->
        <collection property="files" ofType="com.eat.today.sns.query.dto.photoReview.PrFileUploadDTO"
                    resultMap="FileMap"/>
    </resultMap>

    <!-- 단건 조회 -->
    <select id="findByReviewNo" parameterType="int" resultMap="PhotoReviewMap">
        SELECT
            r.review_no,
            r.board_no,
            r.member_no,
            r.review_title,
            r.review_content,
            r.review_date,
            r.review_like,
            f.pr_file_no,
            f.pr_file_name,
            f.pr_file_type,
            f.pr_file_rename,
            f.pr_file_path,
            f.pr_file_at,
            f.review_no AS file_review_no
        FROM photo_review r
                 LEFT JOIN pr_file_upload f ON r.review_no = f.review_no
        WHERE r.review_no = #{reviewNo}
        ORDER BY f.pr_file_no ASC
    </select>

    <!-- 게시판별 목록 -->
    <select id="findByBoardNo" parameterType="int" resultMap="PhotoReviewMap">
        SELECT
            r.review_no,
            r.board_no,
            r.member_no,
            r.review_title,
            r.review_content,
            r.review_date,
            r.review_like,
            f.pr_file_no,
            f.pr_file_name,
            f.pr_file_type,
            f.pr_file_rename,
            f.pr_file_path,
            f.pr_file_at,
            f.review_no AS file_review_no
        FROM photo_review r
                 LEFT JOIN pr_file_upload f ON r.review_no = f.review_no
        WHERE r.board_no = #{boardNo}
        ORDER BY r.review_no DESC, f.pr_file_no ASC
    </select>

    <!-- 멤버별 목록 -->
    <select id="findByMemberNo" parameterType="int" resultMap="PhotoReviewMap">
        SELECT
            r.review_no,
            r.board_no,
            r.member_no,
            r.review_title,
            r.review_content,
            r.review_date,
            r.review_like,
            f.pr_file_no,
            f.pr_file_name,
            f.pr_file_type,
            f.pr_file_rename,
            f.pr_file_path,
            f.pr_file_at,
            f.review_no AS file_review_no
        FROM photo_review r
                 LEFT JOIN pr_file_upload f ON r.review_no = f.review_no
        WHERE r.member_no = #{memberNo}
        ORDER BY r.review_no DESC, f.pr_file_no ASC
    </select>

    <select id="findLatestByBoard" resultType="com.eat.today.sns.query.dto.photoReview.PRDTO">
        SELECT
            pr.review_no      AS reviewNo,
            pr.board_no       AS boardNo,
            pr.member_no      AS memberNo,
            pr.review_title   AS reviewTitle,
            pr.review_content AS reviewContent,
            pr.review_date    AS reviewDate,
            pr.review_like    AS reviewLike
        FROM photo_review pr
        WHERE pr.board_no = #{boardNo}
        ORDER BY pr.review_date DESC
            LIMIT 6
    </select>

</mapper>
