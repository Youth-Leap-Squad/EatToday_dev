<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eat.today.event.albti.query.mapper.AlbtiMapper">

    <!-- 결과 매핑 -->
    <resultMap id="AlbtiResultMap" type="com.eat.today.event.albti.query.dto.SelectAlbtiDTO">
        <!-- 회원 정보 -->
            <association property="albti_join_member" javaType="com.eat.today.event.albti.query.dto.AlbtiJoinMemberDTO">
            <result property="member_no" column="member_no"/>
        </association>

        <!-- 술BTI 카테고리/디테일 -->
        <association property="albti_dto" javaType="com.eat.today.event.albti.query.dto.AlbtiDTO">
            <result property="alBTI_category" column="final_type"/>
            <result property="alBTI_detail" column="final_detail"/>
        </association>

        <!-- 술BTI 설명 -->
        <association property="albti_output" javaType="com.eat.today.event.albti.query.dto.AlbtiOutputDTO">
            <result property="alBTI_alcohol_explain" column="alBTI_alcohol_explain"/>
        </association>

        <!-- 음식 정보 -->
        <association property="foodpost_dto" javaType="com.eat.today.event.albti.query.dto.FoodPostDTO">
            <result property="food_explain" column="food_explain"/>
            <result property="food_picture" column="food_picture"/>
        </association>
    </resultMap>

    <!-- ✅ 수정된 조회 쿼리 aaaababaaa-->
    <select id="selectAlbti" parameterType="int" resultMap="AlbtiResultMap">
        SELECT
        r.member_no,
        r.final_type,
        r.final_detail,
        o.alBTI_alcohol_explain,
        f.food_explain,
        f.food_picture
        FROM albti_final_result r

        <!--        /* final_type 을 '/'로 분해한 후보들 중 랜덤 1개를 뽑는 파생 테이블 */-->
        JOIN (
        SELECT
        r2.member_no,
        SUBSTRING_INDEX(SUBSTRING_INDEX(r2.final_type, '/', n.n), '/', -1) AS picked_type
        FROM albti_final_result r2
        JOIN (
        SELECT 1 AS n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5
        ) n
        ON n.n &lt;= LENGTH(r2.final_type) - LENGTH(REPLACE(r2.final_type, '/', '')) + 1
        WHERE r2.member_no = #{member_no}
        ORDER BY RAND()
        LIMIT 1
        ) t ON t.member_no = r.member_no

        <!--        /* 선택된 유형으로 알BTI / 추천 술 / 추천 안주 랜덤 1개 */-->
        LEFT JOIN albti a ON a.alBTI_category = t.picked_type
        LEFT JOIN albti_output o ON o.alBTI_no = a.alBTI_no
        LEFT JOIN food_post f ON f.alcohol_no = a.alcohol_no

        <!--        /* 같은 술(alcohol_no) 내에서도 안주를 랜덤 1개 */-->
        ORDER BY RAND()
        LIMIT 1
    </select>
</mapper>
